#!/bin/bash
zeit=$(date +%Y-%m-%d-%H-%M)

dbquery=$(mysql -u root -e "use nistkasten; select filename from picture WHERE isBackuped = 0 AND (file_type = 1 OR file_type = 2)")
array=( $( for i in $dbquery ; do echo $i ; done ) )

cnt=${#array[@]}
for (( i=1 ; i<cnt ; i++ ))
do 
	cp /home/pi/nistkasten/public/birdimage/normal/${array[$i]}.jpg /home/pi/nistkasten/bashscripts/backup_photo/zipfolder/${array[$i]}.jpg
	echo "Bild zum Backupordner hinzufuegen $i: ${array[$i]}" >> /var/log/nistkasten.log
done

if (($cnt > 0))
then
	cd /home/pi/nistkasten/bashscripts/backup_photo/zipfolder
	zip /home/pi/nistkasten/bashscripts/backup_photo/backup_$zeit.zip ./*
	wput /home/pi/nistkasten/bashscripts/backup_photo/backup_$zeit.zip ftp://$2:$3@$1/backup_photo_$zeit.zip -B
	if [[ $? != 0 ]]; then
	  echo "Transfer failed!" >> /var/log/nistkasten.log
	  exit 2
	else
	  echo "Transfer ueber FTP fertiggestellt." >> /var/log/nistkasten.log
		string=""
		for (( i=1 ; i<cnt ; i++ ))
		do
	        	if(($i==1))
			then
				string="filename LIKE '${array[$i]}'"
			else
				string+=" OR filename LIKE '${array[$i]}'"
			fi
	    	done
		mysql -u root -e "use nistkasten; UPDATE picture SET isBackuped = 1 WHERE ($string) AND (file_type = 1 OR file_type = 2)"
		if [[ $? != 0 ]]; then
	        	echo "Backup failed by MySQL saveing!" >> /var/log/nistkasten.log
	        	exit 1
          	else
			rm /home/pi/nistkasten/bashscripts/backup_photo/backup_$zeit.zip
		fi
		rm /home/pi/nistkasten/bashscripts/backup_photo/zipfolder/*
		exit 0
	fi
else
	echo "Keine neuen Bilder fuer eine Sicherung verfuegbar" >> /var/log/nistkasten.log
	exit 1
fi
