#!/bin/bash
zeit=$(date +%Y-%m-%d-%H-%M)
#tar cfvz backup/backup_$zeit.tar.gz /home/pi/nistkasten/public/nistkasten/normal/*
#wput /home/pi/backup/backup_$zeit.tar.gz ftp://nistkasten@mkrams.de:kuchensamstag07@ftp.mkrams.de/backup_$zeit.tar.gz
#if [[ $? != 0 ]]; then
#  echo "Transfer failed!"
#  exit 1
#else
#  echo "Transfer complete."
#fi

dbquery=$(mysql -u root -e "use nistkasten; select filename from picture WHERE isBackuped = 0")
array=( $( for i in $dbquery ; do echo $i ; done ) )

cnt=${#array[@]}
for (( i=1 ; i<cnt ; i++ ))
do 
	cp /home/pi/nistkasten/public/birdimage/normal/${array[$i]} /home/pi/backup/zipfolder/${array[$i]}
	echo "Bild zum Backupordner hinzufuegen $i: ${array[$i]}" >> /var/log/nistkasten.log
done

if (($cnt > 0))
then
	cd /home/pi/backup/zipfolder
	zip /home/pi/backup/backup_$zeit.zip ./*
	wput /home/pi/backup/backup_$zeit.zip ftp://nistkasten@mkrams.de:kuchensamstag07@ftp.mkrams.de/backup_$zeit.zip -B
	if [[ $? != 0 ]]; then
	  echo "Transfer failed!" >> /var/log/nistkasten.log
	  exit 1
	else
	  echo "Transfer ueber FTP fertiggestellt." >> /var/log/nistkasten.log
		string=""
		for (( i=1 ; i<cnt ; i++ ))
		do
	        	if(($i==1))
			then
				string="filename LIKE '${array[$i]}'"
			else
				string+=" OR filename LIKE '${array[$i]}'"
			fi
	    	done
		mysql -u root -e "use nistkasten; UPDATE picture SET isBackuped = 1 WHERE $string"
		if [[ $? != 0 ]]; then
	        	echo "Backup failed by MySQL saveing!" >> /var/log/nistkasten.log
          	else
			rm /home/pi/backup/backup_$zeit.zip
		fi
		rm /home/pi/backup/zipfolder/*
	fi
else
	echo "Keine neuen Bilder fuer eine Sicherung verfuegbar" >> /var/log/nistkasten.log
fi
